<!DOCTYPE html>
<html>
<head>
    <title>Test Decrypt Backup</title>
</head>
<body>
    <h1>Test Decrypt Backup</h1>
    <input type="file" id="fileInput" accept=".json">
    <pre id="output"></pre>

    <script>
        const ENCRYPTION_KEY = 'selfQ-secure-key-2024';
        const SALT_ROUNDS = 3;

        async function deriveKey(password, salt) {
            const encoder = new TextEncoder();
            const keyMaterial = await crypto.subtle.importKey(
                'raw',
                encoder.encode(password),
                'PBKDF2',
                false,
                ['deriveKey']
            );

            return crypto.subtle.deriveKey(
                {
                    name: 'PBKDF2',
                    salt: salt,
                    iterations: 100000,
                    hash: 'SHA-256',
                },
                keyMaterial,
                { name: 'AES-GCM', length: 256 },
                false,
                ['decrypt']
            );
        }

        async function decryptOnce(encryptedData, password) {
            const decoder = new TextDecoder();
            const binaryString = atob(encryptedData);
            const combined = new Uint8Array(binaryString.length);
            
            for (let i = 0; i < binaryString.length; i++) {
                combined[i] = binaryString.charCodeAt(i);
            }

            const salt = combined.slice(0, 16);
            const iv = combined.slice(16, 28);
            const data = combined.slice(28);

            const key = await deriveKey(password, salt);

            const decrypted = await crypto.subtle.decrypt(
                { name: 'AES-GCM', iv: iv },
                key,
                data
            );

            return decoder.decode(decrypted);
        }

        async function decrypt(encryptedData) {
            let result = encryptedData;
            for (let i = SALT_ROUNDS - 1; i >= 0; i--) {
                const layerKey = `${ENCRYPTION_KEY}-layer-${i}`;
                result = await decryptOnce(result, layerKey);
            }
            return result;
        }

        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const output = document.getElementById('output');
                output.textContent = 'Decrypting...\n';

                const decrypted = await decrypt(text);
                const parsed = JSON.parse(decrypted);
                
                output.textContent = 'SUCCESS!\n\n';
                output.textContent += 'Signature: ' + (parsed.signature || 'NONE') + '\n';
                output.textContent += 'Has data: ' + (parsed.data ? 'YES' : 'NO') + '\n';
                if (parsed.data) {
                    output.textContent += 'Version: ' + (parsed.data.version || 'NONE') + '\n';
                    output.textContent += 'User: ' + (parsed.data.user?.name || 'NONE') + '\n';
                    output.textContent += 'Posts: ' + (parsed.data.posts?.length || 0) + '\n';
                }
                output.textContent += '\n\nFull decrypted data:\n' + JSON.stringify(parsed, null, 2);
            } catch (error) {
                document.getElementById('output').textContent = 'ERROR: ' + error.message + '\n\n' + error.stack;
            }
        });
    </script>
</body>
</html>
